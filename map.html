<!DOCTYPE html>
<html>
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155991615-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "UA-155991615-1");
    </script>

    <!-- my stuff -->
    <meta charset="utf-8">
    <title>Canberra's COVID-19-free year</title>
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- initial scripts -->
    <script src="./resources/d3.v6.min.js"></script>
    <script src="./resources/topojson.v3.min.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet">
    <link href="./resources/style.css" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
  </head>

  <body>
    <div id="map"></div>
    <div id="footer"></div>
    <script>
      // load LGA data
      d3.json("./data/lga.topojson")
        .then(function(data) {
          lgaData = topojson.feature(data, data.objects.areas);
          bounds = d3.geoBounds(lgaData);
          // temp test
          lgaData.features.forEach(function(d) {
            d.properties.height = d3.max(d.properties.data) * 5000;
            console.log(d.properties);
            // d.properties.colour = "rgba(255, 97, 0, " + (d3.max(d.properties.height) / 131) + ")";
          });
          // set up MapBox engine
          mapboxgl.accessToken = "pk.eyJ1IjoibmV3cy1vbjFpbmUiLCJhIjoiR3FlZFZlVSJ9._30EFE9XYhQitqf4gzRG-g";
          map = new mapboxgl.Map({
            container: "map",
            attributionControl: false,
            style: "mapbox://styles/mapbox/light-v10",
            center: [134.354806, -25.610111],
            pitch: 0,
            bearing: 0,
            zoom: (document.body.getBoundingClientRect().width < 500 ? 2 : 3)
          });
          map.on("load", function() {
            // add navigation and custom attribution
            map.addControl(new mapboxgl.AttributionControl({
                compact: true,
                customAttribution: "ACT Health, NSW Health, ABS (LGA boundaries)"
              }))
              .addSource("lgaSource", {
                type: "geojson",
                data: lgaData
              })
              .addLayer({
                id: "lga",
                type: "fill-extrusion",
                source: "lgaSource",
                paint: {
                  "fill-extrusion-color": "blue",
                  "fill-extrusion-height": ["get", "height"]
                }
              });
            // fade in
            d3.select("body")
              .transition()
                .duration(500)
                .style("opacity", 1);
            // transition to LGAs
            d3.timeout(function() {

              map.fitBounds(bounds, {
                padding: {
                    right: -100, left: -300
                  },
                pitch: 60,
                bearing: 30,
                duration: 3000,
                essential: true
              });
            }, 1000);
          });
        });
    </script>
  </body>
</html>
